---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: s3
  namespace: argocd
spec:
  goTemplate: true
  generators:
    - git:
        repoURL: https://github.com/roscoejp/sample-cluster.git
        revision: HEAD
        # https://argo-cd.readthedocs.io/en/release-2.9/operator-manual/applicationset/Generators-Git/#git-generator-files
        files:
          - path: "namespaces/**/requirements.json"
  strategy:
    type: RollingSync
    rollingSync:
      steps:
        # Rollout ordering based on application "tiers":
        # T1 = infra, T2 = requirements, T3 = top level
        - matchExpressions:
            - key: tier
              operator: In
              values: ["infra"]
          maxUpdate: 1
        - matchExpressions:
            - key: tier
              operator: In
              values: ["requirements"]
        - matchExpressions:
            - key: tier
              operator: In
              values: ["application"]
  template:
    metadata:
      name: "{{index .path.segments 1}}-{{.path.basenameNormalized}}"
      labels:
        tier: "{{ .path.filename | trimSuffix '.json' }}"
    spec:
      destination:
        server: https://kubernetes.default.svc # ArgoCD's own cluster
        namespace: "{{index .path.segments 1}}" # should be /namespaces[0]/namespace1[1]
      project: default
      sources:
        # S3 components
        - repoURL: "{{.s3.values.repoURL}}"
          targetRevision: "{{.s3.values.revision}}"
          ref: s3_values # Allows us to reference repo w/ templating
        - repoURL: "{{.s3.chart.repoURL}}"
          path: "{{.s3.chart.path}}"
          targetRevision: "{{.s3.chart.revision}}"
          helm:
            # https://argo-cd.readthedocs.io/en/latest/user-guide/helm/#helm-value-precedence
            values: |
              prefix: "{{.path.basenameNormalized}}"
              suffix: "s3"
            valueFiles:
              - $s3_values/applications/{{.path.basenameNormalized}}/requirements/s3-values.yaml
        # Kafka components
        - repoURL: "{{.kafka.values.repoURL}}"
          targetRevision: "{{.kafka.values.revision}}"
          ref: kafka_values # Allows us to reference repo w/ templating
        - repoURL: "{{.kafka.chart.repoURL}}"
          path: "{{.kafka.chart.path}}"
          targetRevision: "{{.kafka.chart.revision}}"
          helm:
            # https://argo-cd.readthedocs.io/en/latest/user-guide/helm/#helm-value-precedence
            values: |
              prefix: "{{.path.basenameNormalized}}"
              suffix: "kafka"
            valueFiles:
              - $kafka_values/applications/{{.path.basenameNormalized}}/requirements/kafka-values.yaml
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
