---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kafka
  namespace: argocd
spec:
  goTemplate: true
  generators:
    - git:
        repoURL: https://github.com/roscoejp/sample-cluster.git
        revision: HEAD
        # https://argo-cd.readthedocs.io/en/release-2.9/operator-manual/applicationset/Generators-Git/#git-generator-files
        files:
          - path: "namespaces/**/requirements.json"
        values:
          component_type: kafka
  template:
    metadata:
      name: "{{path[1]}}-{{values.component_type}}"
    spec:
      destination:
        server: https://kubernetes.default.svc # ArgoCD's own cluster
        namespace: "{{path[1]}}" # should be /namespaces[0]/namespace1[1]
      project: default
      sources:
        - repoURL: "{{kafka.values.repoURL}}"
          targetRevision: "{{kafka.values.revision}}"
          ref: external_values # Allows us to reference repo w/ templating
        - repoURL: "{{kafka.chart.repoURL}}"
          path: "{{kafka.chart.path}}"
          targetRevision: "{{kafka.chart.revision}}"
          helm:
            # https://argo-cd.readthedocs.io/en/latest/user-guide/helm/#helm-value-precedence
            values: |
              prefix: "{{path.basenameNormalized}}"
              suffix: "{{values.component_type}}"
            valueFiles:
              - $external_values/{{path.basenameNormalized}}/requirements/{{values.component_type}}-values.yaml
      syncPolicy:
        syncOptions:
          - PrunePropagationPolicy=undefined
          - CreateNamespace=true
